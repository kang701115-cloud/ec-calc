<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>최적화 기반 양액 계산기</title>

<style>
:root{ --brand:#007bff; --brand-dark:#0056b3; --card-w:900px; }
*{box-sizing:border-box}
body{ background:#f6f7fa; margin:0; padding:20px;
      font-family:Arial, sans-serif; text-align:center;}
h1{color:var(--brand); font-size:2rem; margin-bottom:10px;}
.wrap{max-width:var(--card-w); margin:0 auto;}
.card{
  background:white; padding:20px; margin-bottom:20px;
  border-radius:12px; box-shadow:0 6px 12px rgba(0,0,0,0.08);
  text-align:left;
}
label{font-weight:700; margin-top:10px; display:block;}
input{
  width:100%; padding:10px; margin-top:6px;
  border:1px solid #ccc; border-radius:8px; font-size:1rem;
}
.row{display:flex; flex-wrap:wrap; gap:12px;}
.row>div{flex:1 1 260px;}
.btn{
  background:var(--brand); color:white; border:none;
  padding:14px; border-radius:10px; margin-top:20px;
  font-size:1.1rem; cursor:pointer; width:100%;
}
.btn:hover{background:var(--brand-dark);}

table{width:100%; border-collapse:collapse; margin-top:20px;}
th,td{padding:10px; border:1px solid #eee;}
th{background:#eff4ff;}
.unit-chip{
  font-weight:700; padding:4px 8px; background:#eef2ff;
  border-radius:999px; font-size:0.9rem;
}

.switch{position:relative; width:32px; height:18px; display:inline-block;}
.switch input{opacity:0; width:0; height:0;}
.slider{
  position:absolute; inset:0; background:#cfe2ff;
  border-radius:999px; cursor:pointer; transition:0.2s;
}
.slider:before{
  content:''; position:absolute; width:14px; height:14px;
  background:white; border-radius:50%; left:2px; top:2px;
  transition:0.2s;
}
input:checked + .slider{background:#a9c4ff;}
input:checked + .slider:before{transform:translateX(14px);}

.meta{margin-top:20px; font-size:0.95rem;
      white-space:pre-line; color:#333;}
.bad{color:#b00020; font-weight:700;}
</style>
</head>


<body>
<h1>최적화 기반 양액 계산기</h1>

<div class="wrap">
  <div class="card">

    <h2>기본 입력</h2>

    <div class="row">
      <div><label>배합 용량 (L)</label><input id="V" type="number" step="0.1"></div>
      <div><label>목표 EC (mS/cm)</label><input id="ECt" type="number" step="0.01"></div>
    </div>

    <h3>EC 증가량</h3>
    <div class="row">
      <div><label>AB 500 µL → ΔEC</label><input id="dAB" type="number" step="0.01"></div>
      <div><label>K₂SO₄ 250 µL → ΔEC</label><input id="dK"  type="number" step="0.01"></div>
      <div><label>MgSO₄ 250 µL → ΔEC</label><input id="dMg" type="number" step="0.01"></div>
      <div><label>Ca(NO₃)₂ 250 µL → ΔEC</label><input id="dCa" type="number" step="0.01"></div>
    </div>

    <h3>목표 Ca/Mg (mg/L)</h3>
    <div class="row">
      <div><label>Ca 목표 (mg/L)</label><input id="CaT" type="number"></div>
      <div><label>Mg 목표 (mg/L)</label><input id="MgT" type="number"></div>
    </div>

    <h3>K:N 비율 (근사)</h3>
    <div class="row">
      <div><label>K 값</label><input id="Kr" type="number"></div>
      <div><label>N 값</label><input id="Nr" type="number"></div>
    </div>

    <h3>단위</h3>
    <span class="unit-chip">µL</span>
    <label class="switch"><input id="unit" type="checkbox"><span class="slider"></span></label>
    <span class="unit-chip">mL</span>

    <button class="btn" id="calc">계산하기</button>

    <div id="result"></div>
    <div id="meta" class="meta"></div>

  </div>
</div>


<script>
"use strict";

/* ------------------ AB 성분 (mg/mL) ------------------ */
const AB_N  = 47.40;
const AB_K  = 35.10;
const AB_Ca = 18.50;
const AB_Mg = 4.13;

/* ------------------ MgSO₄ / Ca(NO₃)₂ / K₂SO₄ ------------------ */
const AT = { Mg:24.305, Ca:40.078, O:15.999, N:14.007 };
const M_MgO = AT.Mg + AT.O;
const M_CaO = AT.Ca + AT.O;

const Mg_frac = AT.Mg / M_MgO;
const Ca_frac = AT.Ca / M_CaO;

const mgMg_per_mL = 0.16 * Mg_frac * 0.10 * 1000;
const mgCa_per_mL = 0.26 * Ca_frac * 0.10 * 1000;

/* K₂SO₄ */
const MW_K2SO4 = 174.259;
const K_frac = (39.0983*2) / MW_K2SO4;
const mgK_per_mL = K_frac * 0.10 * 1000;

/* ------------------ 3x3 선형방정식 ------------------ */
function solve3(A,b){
  A=A.map(r=>r.slice());
  b=b.slice();
  for(let i=0;i<3;i++){
    let p=A[i][i];
    if(Math.abs(p)<1e-12){
      for(let r=i+1;r<3;r++){
        if(Math.abs(A[r][i])>1e-12){
          [A[i],A[r]]=[A[r],A[i]];
          [b[i],b[r]]=[b[r],b[i]];
          p=A[i][i];
          break;
        }
      }
    }
    for(let c=i;c<3;c++) A[i][c]/=p;
    b[i]/=p;
    for(let r=0;r<3;r++){
      if(r===i) continue;
      const m=A[r][i];
      for(let c=i;c<3;c++) A[r][c]-=m*A[i][c];
      b[r]-=m*b[i];
    }
  }
  return b;
}

/* ------------------ K:N 오차 함수 ------------------ */
function KN_error(vAB, vK){
  const K = vAB*AB_K + vK*mgK_per_mL;
  const N = vAB*AB_N;
  if(N<=0) return 1e12;

  const Kr = parseFloat(Kr_el.value);
  const Nr = parseFloat(Nr_el.value);
  const target = Kr/Nr;

  return (K/N - target)**2;
}

/* ------------------ Golden-section search ------------------ */
function minimize_vK(vMin, vMax, f){
  const phi = (1+Math.sqrt(5))/2;
  let a=vMin, b=vMax;
  let c=b-(b-a)/phi;
  let d=a+(b-a)/phi;
  while(Math.abs(b-a)>1e-5){
    if(f(c)<f(d)){
      b=d; d=c; c=b-(b-a)/phi;
    } else {
      a=c; c=d; d=a+(b-a)/phi;
    }
  }
  return (a+b)/2;
}

/* ------------------ DOM ------------------ */
const V_el=document.getElementById("V");
const ECt_el=document.getElementById("ECt");
const dAB_el=document.getElementById("dAB");
const dK_el=document.getElementById("dK");
const dMg_el=document.getElementById("dMg");
const dCa_el=document.getElementById("dCa");
const CaT_el=document.getElementById("CaT");
const MgT_el=document.getElementById("MgT");
const Kr_el=document.getElementById("Kr");
const Nr_el=document.getElementById("Nr");
const unit_el=document.getElementById("unit");

/* ------------------ 계산 ------------------ */
document.getElementById("calc").onclick = ()=>{

  const V   = parseFloat(V_el.value);
  const ECt = parseFloat(ECt_el.value);

  const dAB = parseFloat(dAB_el.value)/500;
  const dK  = parseFloat(dK_el.value)/250;
  const dMg = parseFloat(dMg_el.value)/250;
  const dCa = parseFloat(dCa_el.value)/250;

  const CaT = parseFloat(CaT_el.value);
  const MgT = parseFloat(MgT_el.value);

  /* vK → vAB,vMg,vCa 구하는 함수 */
  function solveFor(vK){
    const B = [
      ECt,
      CaT * V,
      MgT * V
    ];
    const A = [
      [ dAB/V,   dMg/V,    dCa/V ],
      [ AB_Ca/1000, 0, mgCa_per_mL/1000 ],
      [ AB_Mg/1000, mgMg_per_mL/1000, 0 ]
    ];
    A[0][0] -= dK*vK/V;
    return solve3(A,B); // [vAB,vMg,vCa]
  }

  /* vK → 오차 함수 */
  function F(vK){
    const [vAB,vMg,vCa] = solveFor(vK);
    if(vAB<0||vMg<0||vCa<0) return 1e12;
    return KN_error(vAB,vK);
  }

  const vK_best = minimize_vK(0,200000,F);
  const [vAB_best,vMg_best,vCa_best] = solveFor(vK_best);

  const unit = unit_el.checked ? 1/1000 : 1;
  const uname = unit_el.checked ? "mL" : "µL";

  document.getElementById("result").innerHTML = `
    <table>
      <tr><th>원액</th><th>주입량 (${uname})</th></tr>
      <tr><td>A액</td><td>${((vAB_best/2)*unit).toFixed(2)}</td></tr>
      <tr><td>B액</td><td>${((vAB_best/2)*unit).toFixed(2)}</td></tr>
      <tr><td>K₂SO₄ 10% 용액</td><td>${(vK_best*unit).toFixed(2)}</td></tr>
      <tr><td>MgSO₄ 10% 용액</td><td>${(vMg_best*unit).toFixed(2)}</td></tr>
      <tr><td>Ca(NO₃)₂ 10% 용액</td><td>${(vCa_best*unit).toFixed(2)}</td></tr>
      <tr><td><b>총합</b></td><td><b>${((vAB_best+vK_best+vMg_best+vCa_best)*unit).toFixed(2)}</b></td></tr>
    </table>
  `;

  document.getElementById("meta").textContent =
`EC, Ca, Mg는 정확히 만족
K:N은 가능한 한 최적으로 근사됨(최소제곱오차 기반)

AB 성분 (mg/mL):
N=${AB_N}, K=${AB_K}, Ca=${AB_Ca}, Mg=${AB_Mg}

MgSO₄ 용액: ${mgMg_per_mL.toFixed(2)} mg Mg / mL
Ca(NO₃)₂ 용액: ${mgCa_per_mL.toFixed(2)} mg Ca / mL
K₂SO₄ 용액: ${mgK_per_mL.toFixed(2)} mg K / mL`;
};
</script>

</body>
</html>
