<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>양액 배합 계산기 — 자동 EC 맞춤(총부피 미지정)</title>
<style>
:root{ --brand:#007BFF; --brand-dark:#0056b3; --card-w: 680px; }
*{box-sizing:border-box}
body{ font-family: Arial, sans-serif; background:#f7f8fa; margin:0; padding:24px; text-align:center; }
h1{color:var(--brand); font-size:2.2rem; margin:0 0 18px}
.wrap{max-width:var(--card-w); margin:0 auto}
.card{ background:#fff; padding:20px; margin:16px auto; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.06); text-align:left; font-size:1.06rem; }
.card h2{margin:0 0 10px; font-size:1.25rem; color:#222}
label{display:block; margin-top:12px; font-weight:700}
.row{display:flex; gap:12px; flex-wrap:wrap}
.row > div{flex:1 1 200px}
input, select{ width:100%; padding:12px; margin-top:6px; border:1px solid #d7d7d7; border-radius:10px; font-size:1.05rem; background:#fff; }
small.hint{display:block; font-size:.9rem; color:#666; margin-top:6px}
.btn{ margin-top:16px; padding:13px 16px; width:100%; background:var(--brand); color:#fff; border:none; border-radius:10px; cursor:pointer; font-size:1.08rem; }
.btn:hover{background:var(--brand-dark)}
.result{margin-top:14px; font-weight:700; color:#222; font-size:1.18rem; white-space:pre-line; word-break:keep-all}
.meta{font-size:.96rem; color:#333; white-space:pre-line; margin-top:8px}
.kbd{display:inline-block; padding:2px 6px; border:1px solid #ddd; border-radius:6px; background:#fafafa; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.95rem}
.pill{display:inline-flex; gap:8px; align-items:center; margin-top:8px; background:#eef6ff; color:#134d9a; padding:8px 12px; border-radius:999px; font-size:.92rem}
hr.sep{border:none; border-top:1px solid #eee; margin:14px 0}
details{margin-top:10px}
details > summary{cursor:pointer; user-select:none; padding:8px 10px; background:#f0f4ff; border:1px solid #d9e2ff; border-radius:10px; color:#274690; font-weight:700}
.details-body{padding:10px 2px; font-size:.98rem; color:#333; white-space:pre-line}
.bad{color:#b00020; font-weight:700}
.ok{color:#0a7a0a; font-weight:700}
.footer{font-size:.9rem; color:#666; margin-top:16px}
</style>
</head>
<body>
<h1>양액 배합 계산기 (자동 EC 맞춤)</h1>
<div class="wrap">

  <div class="card">
    <h2>기본 입력</h2>
    <div class="row">
      <div>
        <label for="waterL">물의 양 (L)</label>
        <input type="number" id="waterL" step="0.01" placeholder="예: 1.00" value="1.00">
        <small class="hint">EC 증분(dE)은 “물 1 L 기준” 수치야. 물 양이 다르면 내부에서 자동 스케일됨.</small>
      </div>
      <div>
        <label for="targetEC">목표 EC (mS/cm)</label>
        <input type="number" id="targetEC" step="0.01" placeholder="예: 1.20">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>1 L 기준 EC 증분 입력 (250 µL 투입 시)</h2>
    <div class="row">
      <div>
        <label for="dEA">A 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dEA" step="0.01" placeholder="예: 0.40">
      </div>
      <div>
        <label for="dEB">B 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dEB" step="0.01" placeholder="예: 0.40">
      </div>
      <div>
        <label for="dEK">10% K₂SO₄ 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dEK" step="0.01" placeholder="예: 0.05">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>조성 비와 밀도</h2>
    <div class="row">
      <div>
        <label for="tK">목표 비 K 부분</label>
        <input type="number" id="tK" step="0.01" placeholder="예: 1">
      </div>
      <div>
        <label for="tN">목표 비 N 부분</label>
        <input type="number" id="tN" step="0.01" placeholder="예: 1">
      </div>
    </div>
    <div class="row">
      <div>
        <label for="rhoA">A 밀도 (g/mL = mg/µL)</label>
        <input type="number" id="rhoA" step="0.001" value="1.21">
      </div>
      <div>
        <label for="rhoB">B 밀도 (g/mL = mg/µL)</label>
        <input type="number" id="rhoB" step="0.001" value="1.21">
      </div>
      <div>
        <label for="rhoK">10% K₂SO₄ 밀도 (가정)</label>
        <input type="number" id="rhoK" step="0.001" value="1.00">
      </div>
    </div>
    <small class="hint">
      혼합물 조성(질량 기준): 100 mg당 K 4.25 mg, N 5.75 mg로 고정. K₂SO₄ 용액의 K 질량비는 약 0.0448 (10 wt% × K₂SO₄ 내 K 비율)로 사용.
    </small>
  </div>

  <div class="card">
    <button class="btn" id="btnCalc">계산하기</button>
    <div class="result" id="result"></div>
    <hr class="sep">
    <div class="meta" id="meta"></div>

    <details>
      <summary>자세히 보기 (가정·계산식·대입값)</summary>
      <div class="details-body" id="debugBox"></div>
    </details>

    <div class="pill">ℹ️ 가정: EC는 “주입량/물량”에 선형, 조성은 질량 기준으로 선형. 필요 시 네가 직접 잰 수치로 보정해서 쓰면 돼.</div>
  </div>

  <div class="footer">
    입력값은 브라우저에 자동 저장됨(localStorage). 새로고침해도 유지돼.
  </div>
</div>

<script>
"use strict";

// ----- 상수(화학량) -----
const ATOMIC = { K: 39.0983, S: 32.065, O: 15.999 };
const M_K2SO4 = 2*ATOMIC.K + ATOMIC.S + 4*ATOMIC.O; // g/mol
const MASSFRAC_K_IN_K2SO4 = (2*ATOMIC.K) / M_K2SO4; // ≈ 0.448
const K_MASS_FRAC_IN_10WT = 0.10 * MASSFRAC_K_IN_K2SO4; // ≈ 0.0448 (용액 전체 대비 K 질량분율)

// ----- 로컬 스토리지 키 -----
const KEY = "mixD_auto_inputs_v1";

// ----- 유틸 -----
function saveInputs(){
  const data = {
    waterL: getNum("waterL"),
    targetEC: getNum("targetEC"),
    dEA: getNum("dEA"),
    dEB: getNum("dEB"),
    dEK: getNum("dEK"),
    tK: getNum("tK"),
    tN: getNum("tN"),
    rhoA: getNum("rhoA"),
    rhoB: getNum("rhoB"),
    rhoK: getNum("rhoK"),
  };
  localStorage.setItem(KEY, JSON.stringify(data));
}
function loadInputs(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    for(const k of Object.keys(d)){
      const el = document.getElementById(k);
      if(el && typeof d[k] === "number" && !Number.isNaN(d[k])) el.value = d[k];
    }
  }catch(e){}
}
function getNum(id){
  const v = parseFloat(document.getElementById(id).value);
  return Number.isFinite(v) ? v : NaN;
}

// ----- 핵심 계산 (총부피 자동 결정) -----
// 아이디어: EC를 가장 적은 총부피로 맞추는 해는 경계해(둘 중 하나 0)에서 나온다.
// 케이스A: vB=0 → A만 + K2SO4, 케이스B: vA=0 → B만 + K2SO4.
// 두 케이스를 계산해 총부피가 더 작은 쪽을 선택.
function calculate(){
  const waterL  = getNum("waterL");    // L
  const ECt     = getNum("targetEC");  // mS/cm

  const dEA     = getNum("dEA");       // mS/cm (250 µL in 1 L)
  const dEB     = getNum("dEB");       // mS/cm
  const dEK     = getNum("dEK");       // mS/cm

  const tK      = getNum("tK");
  const tN      = getNum("tN");

  const rhoA    = getNum("rhoA");      // mg/µL
  const rhoB    = getNum("rhoB");      // mg/µL
  const rhoK    = getNum("rhoK");      // mg/µL (가정)

  const out = document.getElementById("result");
  const meta = document.getElementById("meta");
  const dbg  = document.getElementById("debugBox");
  out.textContent = "";
  meta.textContent = "";
  dbg.textContent  = "";

  // 유효성
  if([waterL, ECt, dEA, dEB, dEK, tK, tN, rhoA, rhoB, rhoK].some(v => !Number.isFinite(v) || v < 0)){
    out.innerHTML = `<span class="bad">값을 모두 올바르게 입력해줘.</span>`;
    return;
  }
  if(waterL === 0){
    out.innerHTML = `<span class="bad">물의 양은 0일 수 없어.</span>`;
    return;
  }
  if(tK === 0 || tN === 0){
    out.innerHTML = `<span class="bad">목표 비의 각 항은 0보다 커야 해.</span>`;
    return;
  }

  // 물 스케일(µL당 EC 기울기)
  const alpha = (dEA / 250) / waterL; // A 한 µL당 EC
  const beta  = (dEB / 250) / waterL; // B 한 µL당 EC
  const gamma = (dEK / 250) / waterL; // K2SO4 한 µL당 EC

  const r = tK / tN;
  const fK = K_MASS_FRAC_IN_10WT;

  // 케이스 A: vB = 0 → S = vA
  //   A+B 질량 = vA*rhoA
  //   deltaK = r*N0 - K0 = (vA*rhoA)*(0.0575*r - 0.0425)
  //   vK = max(0, deltaK/(fK*rhoK)) = cA * vA, where cA = max(0, rhoA*(0.0575*r - 0.0425)/(fK*rhoK))
  //   EC: alpha*vA + gamma*vK = ECt → (alpha + gamma*cA)*vA = ECt → vA = ECt / (alpha + gamma*cA)
  function calcCaseA(){
    const cA_raw = rhoA * (0.0575*r - 0.0425) / (fK * rhoK);
    const cA = Math.max(0, cA_raw);
    const denom = (alpha + gamma*cA);
    if(denom <= 0) return null;
    const vA = ECt / denom;
    const vK = cA * vA;
    const vB = 0;
    const Vtotal = vA + vB + vK;
    return {vA, vB, vK, Vtotal, c: cA, case: "A-only"};
  }

  // 케이스 B: vA = 0 → S = vB
  //   질량 = vB*rhoB, vK = cB*vB, cB = max(0, rhoB*(0.0575*r - 0.0425)/(fK*rhoK))
  //   EC: beta*vB + gamma*vK = ECt → (beta + gamma*cB)*vB = ECt
  function calcCaseB(){
    const cB_raw = rhoB * (0.0575*r - 0.0425) / (fK * rhoK);
    const cB = Math.max(0, cB_raw);
    const denom = (beta + gamma*cB);
    if(denom <= 0) return null;
    const vB = ECt / denom;
    const vK = cB * vB;
    const vA = 0;
    const Vtotal = vA + vB + vK;
    return {vA, vB, vK, Vtotal, c: cB, case: "B-only"};
  }

  const solA = calcCaseA();
  const solB = calcCaseB();

  let sol = null;
  if(solA && solB){
    sol = (solA.Vtotal <= solB.Vtotal) ? solA : solB; // 더 작은 총 주입량 선택
  }else if(solA){
    sol = solA;
  }else if(solB){
    sol = solB;
  }else{
    out.innerHTML = `<span class="bad">해가 없어. (기울기나 입력값을 확인해줘)</span>`;
    return;
  }

  const {vA, vB, vK, Vtotal} = sol;

  // 메타/검증 값 계산
  const massAB_mg = vA*rhoA + vB*rhoB;
  const K0 = massAB_mg * 0.0425;
  const N0 = massAB_mg * 0.0575;
  const K_added = vK * rhoK * fK;
  const K_final = K0 + K_added;
  const N_final = N0;

  const ratio_now = (N0 > 0) ? (K0/N0) : NaN;
  const ratio_final = (N_final > 0) ? (K_final/N_final) : NaN;
  const ratio_target = r;

  const EC_check = alpha*vA + beta*vB + gamma*vK;
  const okEC = Math.abs(EC_check - ECt) < 1e-3;

  const fmtVol = (uL)=> `${uL.toFixed(1)} µL (${(uL/1000).toFixed(3)} mL)`;
  const signed = (x)=> (x>=0?"+":"") + x.toFixed(3);

  // 출력
  const lines = [];
  lines.push(`필요한 A: ${fmtVol(Math.max(0,vA))}`);
  lines.push(`필요한 B: ${fmtVol(Math.max(0,vB))}`);
  lines.push(`필요한 10% K₂SO₄: ${fmtVol(Math.max(0,vK))}`);
  lines.push(`총 주입량(자동 계산): ${fmtVol(Math.max(0,Vtotal))}`);
  document.getElementById("result").textContent = lines.join("\n");

  const metaLines = [];
  metaLines.push(`물 스케일 반영: 물 ${waterL.toFixed(2)} L → µL당 EC = A:${alpha.toFixed(5)}, B:${beta.toFixed(5)}, K₂SO₄:${gamma.toFixed(5)} mS/cm`);
  metaLines.push(`현재 K:N (A+B만) ≈ ${safeRatio(ratio_now)}   /   최종 K:N (K₂SO₄ 반영) ≈ ${safeRatio(ratio_final)}`);
  metaLines.push(`목표 K:N = ${ratio_target.toFixed(3)}   →   차이(최종-목표) = ${signed(ratio_final - ratio_target)}`);
  metaLines.push(`EC 검증: 계산된 EC ≈ ${EC_check.toFixed(3)} mS/cm ${okEC ? "✅" : "⚠️ (목표와 차이: " + (EC_check-ECt).toFixed(3) + ")"}`);
  meta.textContent = metaLines.join("\n");

  // 자세히 보기
  const dbgText = [];
  dbgText.push("[가정]");
  dbgText.push("- EC는 주입량/물량에 선형으로 비례");
  dbgText.push("- 조성은 질량 기준(밀도 사용)");
  dbgText.push("- 혼합물 100 mg당 K 4.25 mg, N 5.75 mg");
  dbgText.push(`- K₂SO₄ 10 wt% 용액의 K 질량분율 fK ≈ ${K_MASS_FRAC_IN_10WT.toFixed(5)}`);
  dbgText.push(`- 밀도: A=${rhoA.toFixed(3)}, B=${rhoB.toFixed(3)}, K₂SO₄=${rhoK.toFixed(3)} (단위 g/mL = mg/µL)`);
  dbgText.push("");
  dbgText.push("[계산식 요약]");
  dbgText.push("물 스케일: alpha=(dE_A/250)/waterL, beta=(dE_B/250)/waterL, gamma=(dE_K/250)/waterL");
  dbgText.push("케이스 A: vB=0 → vK=cA*vA, (alpha+gamma*cA)*vA=EC_target → vA=EC_target/(alpha+gamma*cA)");
  dbgText.push("케이스 B: vA=0 → vK=cB*vB, (beta +gamma*cB)*vB=EC_target → vB=EC_target/(beta +gamma*cB)");
  dbgText.push("여기서 cA = max(0, rhoA*(0.0575*r - 0.0425)/(fK*rhoK)), cB 동일.");
  dbgText.push("두 해 중 총 주입량 vA+vB+vK가 더 작은 것을 선택.");
  dbgText.push("");
  dbgText.push("[대입값/결과]");
  dbgText.push(`waterL=${waterL}, EC_target=${ECt}`);
  dbgText.push(`dE_A=${dEA}, dE_B=${dEB}, dE_K=${dEK} → alpha=${alpha.toFixed(6)}, beta=${beta.toFixed(6)}, gamma=${gamma.toFixed(6)}`);
  dbgText.push(`tK=${tK}, tN=${tN}, r=${r.toFixed(6)}`);
  dbgText.push(`vA=${Math.max(0,vA).toFixed(3)}, vB=${Math.max(0,vB).toFixed(3)}, vK=${Math.max(0,vK).toFixed(3)}, Vtotal=${Math.max(0,Vtotal).toFixed(3)}`);
  dbgText.push(`K0=${K0.toFixed(4)} mg, N0=${N0.toFixed(4)} mg, K_added=${K_added.toFixed(4)} mg`);
  dbgText.push(`K_final=${K_final.toFixed(4)} mg, N_final=${N_final.toFixed(4)} mg`);
  dbgText.push(`K:N now=${safeRatio(ratio_now)}, K:N final=${safeRatio(ratio_final)}, target=${ratio_target.toFixed(3)}`);
  dbgText.push(`EC_check=${EC_check.toFixed(4)} mS/cm`);
  document.getElementById("debugBox").textContent = dbgText.join("\n");

  // 저장
  saveInputs();
}

// 안전 출력용
function safeRatio(r){
  if(!Number.isFinite(r)) return "NaN";
  return r.toFixed(3);
}

// 이벤트
document.getElementById("btnCalc").addEventListener("click", calculate);
window.addEventListener("load", ()=>{
  loadInputs();
});

// 입력 변경 시 자동 저장
for(const id of ["waterL","targetEC","dEA","dEB","dEK","tK","tN","rhoA","rhoB","rhoK"]){
  const el = document.getElementById(id);
  el.addEventListener("change", saveInputs);
}
</script>
</body>
</html>
