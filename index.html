<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>안정형 양액 계산기 (EC·Cㄴa·Mg 정확, K:N 근사)</title>

<style>
:root{ --brand:#0066ff; --card-w:900px; }
*{box-sizing:border-box;}
body{
  background:#f6f7fa;
  font-family:Arial,Helvetica,sans-serif;
  padding:22px;
  text-align:center;
}
h1{color:var(--brand);}
.wrap{max-width:var(--card-w);margin:0 auto;}
.card{
  background:#fff;padding:22px;border-radius:14px;
  box-shadow:0 5px 16px rgba(0,0,0,.07);
  text-align:left;margin-bottom:22px;
}
label{font-weight:700;display:block;margin-top:10px;}
input{
  width:100%;padding:10px;margin-top:5px;
  border:1px solid #ccc;border-radius:8px;font-size:1rem;
}
.row{display:flex;flex-wrap:wrap;gap:14px;}
.row>div{flex:1 1 260px;}
.btn{
  width:100%;padding:15px;margin-top:20px;border:none;
  border-radius:10px;background:var(--brand);color:#fff;
  font-size:1.13rem;cursor:pointer;font-weight:bold;
}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:10px;border:1px solid #eee;}
th{background:#eef4ff;}
.switch{position:relative;width:36px;height:20px;display:inline-block;}
.switch input{opacity:0;width:0;height:0;}
.slider{
  position:absolute;inset:0;background:#cfe2ff;border-radius:999px;cursor:pointer;
}
.slider:before{
  content:'';position:absolute;width:16px;height:16px;left:2px;top:2px;background:#fff;
  border-radius:50%;transition:.25s;
}
input:checked + .slider{background:#a9c4ff;}
input:checked + .slider:before{transform:translateX(16px);}
.meta{
  margin-top:14px;font-size:0.9rem;white-space:pre-line;color:#333;
}
</style>
</head>

<body>

<h1>안정형 양액 계산기 (EC·Ca·Mg 정확 + K:N 근사)</h1>

<div class="wrap">
<div class="card">

<h2>기본 입력</h2>
<div class="row">
  <div><label>배합 용량 (L)</label><input id="V" type="number" step="0.1"></div>
  <div><label>목표 EC (mS/cm)</label><input id="ECt" type="number" step="0.01"></div>
</div>

<h3>EC 증가량</h3>
<div class="row">
  <div><label>AB 500µL → ΔEC</label><input id="dAB" type="number" step="0.01"></div>
  <div><label>K₂SO₄ 250µL → ΔEC</label><input id="dK"  type="number" step="0.01"></div>
  <div><label>MgSO₄ 250µL → ΔEC</label><input id="dMg" type="number" step="0.01"></div>
  <div><label>Ca(NO₃)₂ 250µL → ΔEC</label><input id="dCa" type="number" step="0.01"></div>
</div>

<h3>목표 Ca / Mg (mg/L)</h3>
<div class="row">
  <div><label>Ca 목표</label><input id="CaT" type="number"></div>
  <div><label>Mg 목표</label><input id="MgT" type="number"></div>
</div>

<h3>K:N 비 (근사 적용)</h3>
<div class="row">
  <div><label>K 값</label><input id="Kr" type="number"></div>
  <div><label>N 값</label><input id="Nr" type="number"></div>
</div>

<h3>단위</h3>
<span>µL</span>
<label class="switch"><input id="unit" type="checkbox"><span class="slider"></span></label>
<span>mL</span>

<button class="btn" id="calc">계산하기</button>

<div id="result"></div>
<div id="meta" class="meta"></div>

</div>
</div>

<script>
"use strict";

const $ = id => document.getElementById(id);

/* ===== 자동 저장 ===== */
const STORE_KEY="safe_sweep_v2";
const fields=["V","ECt","dAB","dK","dMg","dCa","CaT","MgT","Kr","Nr","unit"];

function saveData(){
  const o={};
  fields.forEach(id=>{
    const el=$(id);
    o[id]=(el.type==="checkbox")?el.checked:el.value;
  });
  localStorage.setItem(STORE_KEY,JSON.stringify(o));
}
function loadData(){
  const raw=localStorage.getItem(STORE_KEY);
  if(!raw) return;
  const o=JSON.parse(raw);
  fields.forEach(id=>{
    if(o[id]!==undefined){
      const el=$(id);
      if(el.type==="checkbox") el.checked=o[id];
      else el.value=o[id];
    }
  });
}
fields.forEach(id=>{
  $(id).addEventListener("input",()=>setTimeout(saveData,150));
});
loadData();

/* ===== AB 성분 (mg/mL) ===== */
const AB_N  = 47.40;
const AB_K  = 35.10;
const AB_Ca = 18.50;
const AB_Mg = 4.13;

/* ===== 보충제 성분 (mg/mL) ===== */
const AT={Mg:24.305,Ca:40.078,O:15.999};
const Mg_frac=AT.Mg/(AT.Mg+AT.O);
const Ca_frac=AT.Ca/(AT.Ca+AT.O);

const mgMg_mL = 0.16 * Mg_frac * 100;   // 16% MgO, 10wt% 용액
const mgCa_mL = 0.26 * Ca_frac * 100;   // 26% CaO, 10wt% 용액

const MW_K2SO4=174.259;
const K_frac=(39.0983*2)/MW_K2SO4;
const mgK_mL = K_frac * 100;            // 10wt% 용액

/* ===== 3×3 선형 방정식 ===== */
function solve3(A,b){
  A=A.map(r=>r.slice());
  b=b.slice();
  for(let i=0;i<3;i++){
    let max=i;
    for(let r=i+1;r<3;r++){
      if(Math.abs(A[r][i])>Math.abs(A[max][i])) max=r;
    }
    if(Math.abs(A[max][i])<1e-12) return null;
    if(max!==i){
      [A[i],A[max]]=[A[max],A[i]];
      [b[i],b[max]]=[b[max],b[i]];
    }
    const piv=A[i][i];
    for(let c=i;c<3;c++) A[i][c]/=piv;
    b[i]/=piv;
    for(let r=0;r<3;r++){
      if(r===i) continue;
      const m=A[r][i];
      for(let c=i;c<3;c++) A[r][c]-=m*A[i][c];
      b[r]-=m*b[i];
    }
  }
  return b;
}

/* ===== 계산 버튼 ===== */
$("calc").onclick=()=>{
  const V    = parseFloat($("V").value);
  const ECt  = parseFloat($("ECt").value);
  const dABv = parseFloat($("dAB").value);
  const dKv  = parseFloat($("dK").value);
  const dMgv = parseFloat($("dMg").value);
  const dCav = parseFloat($("dCa").value);
  const CaT  = parseFloat($("CaT").value);
  const MgT  = parseFloat($("MgT").value);
  const Krv  = parseFloat($("Kr").value);
  const Nrv  = parseFloat($("Nr").value);

  const meta = $("meta");
  const result = $("result");
  meta.textContent="";
  result.innerHTML="";

  if(![V,ECt,dABv,dKv,dMgv,dCav,CaT,MgT,Krv,Nrv].every(Number.isFinite) || V<=0){
    meta.textContent="❌ 입력값을 다시 확인해줘.";
    return;
  }

  const sAB=dABv/500;
  const sK =dKv /250;
  const sMg=dMgv/250;
  const sCa=dCav/250;

  const EC_RHS = ECt * V;
  const Ca_RHS = CaT * V * 1000;
  const Mg_RHS = MgT * V * 1000;
  const KNtarget = Krv/Nrv;

  const vK_max = Math.max(0,(EC_RHS/sK)*0.99);

  let best=null;
  let bestErr=1e99;

  const steps=700;
  for(let i=0;i<=steps;i++){
    const vK = vK_max * i/steps;

    const A=[
      [ sAB,      sMg,      sCa ],
      [ AB_Ca,    0,        mgCa_mL ],
      [ AB_Mg,    mgMg_mL,  0 ]
    ];
    const b=[
      EC_RHS - sK*vK,
      Ca_RHS,
      Mg_RHS
    ];

    if(b[0] < 0) continue;

    const sol=solve3(A,b);
    if(!sol) continue;
    const [vAB,vMg,vCa]=sol;
    if(vAB<0||vMg<0||vCa<0) continue;

    const K = vAB*AB_K + vK*mgK_mL;
    const N = vAB*AB_N;
    if(N<=0) continue;

    const err=(K/N - KNtarget)**2;
    if(err<bestErr){
      bestErr=err;
      best={vAB,vK,vMg,vCa};
    }
  }

  if(!best){
    meta.textContent="❌ EC·Ca·Mg를 만족하면서 K:N을 근사할 수 있는 조합을 찾지 못했어.";
    return;
  }

  const {vAB,vK,vMg,vCa}=best;

  const unitChecked = $("unit").checked;
  const factor = unitChecked?1/1000:1;
  const uname  = unitChecked?"mL":"µL";

  const Aamt=(vAB/2)*factor;
  const Bamt=(vAB/2)*factor;
  const Kamp=vK*factor;
  const Mgamp=vMg*factor;
  const Caamp=vCa*factor;

  result.innerHTML=`
  <table>
    <tr><th>원액</th><th>주입량 (${uname})</th></tr>
    <tr><td>A액</td><td>${Aamt.toFixed(2)}</td></tr>
    <tr><td>B액</td><td>${Bamt.toFixed(2)}</td></tr>
    <tr><td>K₂SO₄ 10%</td><td>${Kamp.toFixed(2)}</td></tr>
    <tr><td>MgSO₄ 10%</td><td>${Mgamp.toFixed(2)}</td></tr>
    <tr><td>Ca(NO₃)₂ 10%</td><td>${Caamp.toFixed(2)}</td></tr>
    <tr><td><b>총합</b></td><td><b>${(Aamt+Bamt+Kamp+Mgamp+Caamp).toFixed(2)}</b></td></tr>
  </table>
  `;

  const K_real = (vAB*AB_K + vK*mgK_mL)/(vAB*AB_N);
  meta.textContent =
`✔ EC / Ca / Mg는 식으로 정확히 맞춘 상태
✔ K:N 비는 가능한 범위에서 최적 근사

실제 K:N ≈ ${K_real.toFixed(3)}
목표 K:N = ${KNtarget.toFixed(3)}
제곱 오차 = ${bestErr.toExponential(3)}`;
};
</script>

</body>
</html>
