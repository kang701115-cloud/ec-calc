<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>양액 배합 계산기</title>
<style>
:root{ --brand:#007BFF; --brand-dark:#0056b3; --card-w: 760px; }
*{box-sizing:border-box}
body{ font-family: Arial, sans-serif; background:#f7f8fa; margin:0; padding:24px; text-align:center; }
h1{color:var(--brand); font-size:2.1rem; margin:0 0 18px}
.wrap{max-width:var(--card-w); margin:0 auto}
.card{ background:#fff; padding:20px; margin:16px auto; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.06); text-align:left; font-size:1.06rem; }
.card h2{margin:0 0 10px; font-size:1.22rem; color:#222}
label{display:block; margin-top:12px; font-weight:700}
.row{display:flex; gap:12px; flex-wrap:wrap}
.row > div{flex:1 1 220px}
input{ width:100%; padding:12px; margin-top:6px; border:1px solid #d7d7d7; border-radius:10px; font-size:1.05rem; background:#fff; }
small.hint{display:block; font-size:.9rem; color:#666; margin-top:6px}
.btn{ margin-top:16px; padding:13px 16px; width:100%; background:var(--brand); color:#fff; border:none; border-radius:10px; cursor:pointer; font-size:1.08rem; }
.btn:hover{background:var(--brand-dark)}
.result{margin-top:14px; font-weight:700; color:#222; font-size:1.18rem; white-space:pre-line; word-break:keep-all}
.meta{font-size:.96rem; color:#333; white-space:pre-line; margin-top:10px}
.kbd{display:inline-block; padding:2px 6px; border:1px solid #ddd; border-radius:6px; background:#fafafa; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.95rem}
.pill{display:inline-flex; gap:8px; align-items:center; margin-top:8px; background:#eef6ff; color:#134d9a; padding:8px 12px; border-radius:999px; font-size:.92rem}
hr.sep{border:none; border-top:1px solid #eee; margin:14px 0}
details{margin-top:10px}
details > summary{cursor:pointer; user-select:none; padding:8px 10px; background:#f0f4ff; border:1px solid #d9e2ff; border-radius:10px; color:#274690; font-weight:700}
.details-body{padding:10px 2px; font-size:.98rem; color:#333; white-space:pre-line}
.bad{color:#b00020; font-weight:700}
.ok{color:#0a7a0a; font-weight:700}
.footer{font-size:.9rem; color:#666; margin-top:16px}
</style>
</head>
<body>
<h1>양액 배합 계산기</h1>
<div class="wrap">

  <div class="card">
    <h2>배치(최종) 부피 & 목표</h2>
    <div class="row">
      <div>
        <label for="Vbatch">배치 부피 (L)</label>
        <input type="number" id="Vbatch" step="0.1" placeholder="예: 2, 20">
        <small class="hint">이번에 실제로 만들 총 용액의 부피(리터).</small>
      </div>
      <div>
        <label for="ECt">목표 EC (mS/cm, 1 L 기준)</label>
        <input type="number" id="ECt" step="0.01" placeholder="예: 1.20">
        <small class="hint">EC는 리터당 목표치이므로, 배치 부피가 커져도 리터당 필요량에 배치 부피를 곱해 계산해.</small>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>EC 증분(1 L 기준, 주입 기준량)</h2>
    <div class="row">
      <div>
        <label for="dE_AB_500">AB 혼합 500 µL(= A 250 + B 250) → EC 증가 (mS/cm)</label>
        <input type="number" id="dE_AB_500" step="0.01" placeholder="예: 0.80">
        <small class="hint">A와 B는 항상 동량. 이 값은 “두 개 합쳐 500 µL 주입 시”의 EC 증가.</small>
      </div>
      <div>
        <label for="dE_K_250">10% K₂SO₄ 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dE_K_250" step="0.01" placeholder="예: 0.05">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>K₂SO₄ 밀도와 목표 K:N</h2>
    <div class="row">
      <div>
        <label for="rhoK">10% K₂SO₄ 밀도 (g/mL = mg/µL)</label>
        <input type="number" id="rhoK" step="0.001" value="1.00">
      </div>
      <div>
        <label for="tK">목표 K 부분</label>
        <input type="number" id="tK" step="0.01" placeholder="예: 1">
      </div>
      <div>
        <label for="tN">목표 N 부분</label>
        <input type="number" id="tN" step="0.01" placeholder="예: 1">
      </div>
    </div>
    <small class="hint">
      고정 가정: AB 혼합 밀도 = <b>1.21 g/mL</b> (= mg/µL), AB 혼합 100 mg당 N=5.75 mg, K=4.25 mg(고정).<br>
      10 wt% K₂SO₄ 용액의 K 질량분율 ≈ 0.0448. 입력된 EC 증분값은 모두 1 L 기준.
    </small>
  </div>

  <div class="card">
    <button class="btn" id="btnCalc">계산하기</button>
    <div class="result" id="result"></div>
    <hr class="sep">
    <div class="meta" id="meta"></div>

    <details>
      <summary>자세히 보기 (가정·계산식·대입값)</summary>
      <div class="details-body" id="debugBox"></div>
    </details>

    <div class="pill">ℹ️ EC는 주입량/물량에 선형, 조성은 질량 기준(밀도 사용)으로 선형 가정.</div>
  </div>

  <div class="footer">
    입력값은 브라우저에 자동 저장됨(localStorage).
  </div>
</div>

<script>
"use strict";

/* ===== 고정 상수 ===== */
const RHO_AB = 1.21; // g/mL = mg/µL (AB 혼합 밀도)
const ATOMIC = { K: 39.0983, S: 32.065, O: 15.999 };
const M_K2SO4 = 2*ATOMIC.K + ATOMIC.S + 4*ATOMIC.O;
const MASSFRAC_K_IN_K2SO4 = (2*ATOMIC.K) / M_K2SO4; // ≈0.448
const F_K = 0.10 * MASSFRAC_K_IN_K2SO4;             // 10 wt% 용액 내 K 질량비 ≈ 0.0448
const KEY = "EC_first_equalAB_per_batch_v1";

/* ===== 유틸 ===== */
function getNum(id){ const v = parseFloat(document.getElementById(id).value); return Number.isFinite(v) ? v : NaN; }
function fmt(uL){ return `${uL.toFixed(1)} µL (${(uL/1000).toFixed(3)} mL)`; }
function safeRatio(r){ return Number.isFinite(r) ? r.toFixed(3) : "NaN"; }
function pm(x){ return (x>=0?"+":"") + x.toFixed(3); }

/* ===== 저장/불러오기 ===== */
function saveInputs(){
  const data = {
    Vbatch: getNum("Vbatch"),
    ECt: getNum("ECt"),
    dE_AB_500: getNum("dE_AB_500"),
    dE_K_250: getNum("dE_K_250"),
    rhoK: getNum("rhoK"),
    tK: getNum("tK"),
    tN: getNum("tN"),
  };
  localStorage.setItem(KEY, JSON.stringify(data));
}
function loadInputs(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    for(const k of Object.keys(d)){
      const el = document.getElementById(k);
      if(el && typeof d[k] === "number" && !Number.isNaN(d[k])) el.value = d[k];
    }
  }catch(e){}
}

/* ===== 핵심 계산 (1 L당 → 배치 부피 곱) =====
입력:
- Vbatch (L)
- ECt (mS/cm)
- dE_AB_500 (mS/cm) : AB 500µL 주입 시 1L 증분
- dE_K_250  (mS/cm) : K2SO4 250µL 주입 시 1L 증분
- rhoK (mg/µL)
- tK, tN (목표 K:N)
고정:
- RHO_AB, F_K
출력:
- vAB_total, vK_total (배치 기준), A=B=vAB_total/2
- 총 주입량, K:N 현재/최종/목표, 달성 EC
*/
function calculate(){
  const Vbatch   = getNum("Vbatch");
  const ECt      = getNum("ECt");
  const dE_AB_500= getNum("dE_AB_500");
  const dE_K_250 = getNum("dE_K_250");
  const rhoK     = getNum("rhoK");
  const tK       = getNum("tK");
  const tN       = getNum("tN");

  const out = document.getElementById("result");
  const meta= document.getElementById("meta");
  const dbg = document.getElementById("debugBox");
  out.textContent=""; meta.textContent=""; dbg.textContent="";

  // 유효성
  if([Vbatch, ECt, dE_AB_500, dE_K_250, rhoK, tK, tN].some(v => !Number.isFinite(v) || v < 0)){
    out.innerHTML = `<span class="bad">값을 모두 올바르게 입력해줘.</span>`; return;
  }
  if(Vbatch === 0){ out.innerHTML = `<span class="bad">배치 부피는 0일 수 없어.</span>`; return; }
  if(tK === 0 || tN === 0){ out.innerHTML = `<span class="bad">목표 비의 각 항은 0보다 커야 해.</span>`; return; }

  // 1) 1 L당 µL→EC 기울기
  const sAB   = dE_AB_500 / 500;  // AB 혼합 1µL당 mS/cm
  const gamma = dE_K_250 / 250;   // K2SO4 1µL당 mS/cm

  // 2) 목표 K:N (r) → K2SO4 필요 비율 c (vK = c * vAB, 1 L 기준)
  const r = tK / tN;
  const c_raw = (RHO_AB * (0.0575*r - 0.0425)) / (F_K * rhoK);
  const c = Math.max(0, c_raw); // K를 줄일 수 없으니 음수면 0으로

  // 3) EC 1순위: (sAB + gamma*c) * vAB_perL = ECt
  const denom = sAB + gamma * c;
  if(denom <= 0){
    out.innerHTML = `<span class="bad">EC 기울기 합이 0 이하야. dE 값들을 확인해줘.</span>`; return;
  }
  const vAB_perL = ECt / denom;   // 1 L당 AB 혼합량
  const vK_perL  = c * vAB_perL;  // 1 L당 K2SO4

  // 4) 배치 부피 곱
  const vAB_total = vAB_perL * Vbatch;
  const vK_total  = vK_perL  * Vbatch;
  const vA_total  = vAB_total / 2;
  const vB_total  = vAB_total / 2;
  const Vtotal    = vAB_total + vK_total; // 참고

  // 5) K:N 현재/최종
  const massAB_mg_perL = vAB_perL * RHO_AB;
  const K0_perL = massAB_mg_perL * 0.0425;
  const N0_perL = massAB_mg_perL * 0.0575;
  const K_added_perL = vK_perL * rhoK * F_K;
  const K_final_perL = K0_perL + K_added_perL;
  const N_final_perL = N0_perL;

  const ratio_now  = (N0_perL  > 0)? (K0_perL / N0_perL) : NaN;
  const ratio_fin  = (N_final_perL > 0)? (K_final_perL / N_final_perL) : NaN;
  const intrinsic  = 0.0425/0.0575; // ≈ 0.73913

  // 6) 달성 EC (검증, 1 L 기준)
  const EC_calc_perL = sAB * vAB_perL + gamma * vK_perL;

  // 알림
  const warns = [];
  if(c_raw < 0){
    warns.push("목표 K:N이 AB 고유비(≈0.739)보다 낮아. K₂SO₄로 K를 줄일 수 없어서 vK=0이 최선이야.");
  }

  // 출력
  const lines = [];
  lines.push(`필요한 AB 혼합 총량: ${fmt(vAB_total)}  →  A=${fmt(vA_total)}, B=${fmt(vB_total)}`);
  lines.push(`필요한 10% K₂SO₄ 총량: ${fmt(Math.max(0, vK_total))}`);
  lines.push(`참고) 총 주입량: ${fmt(Vtotal)} (AB+K₂SO₄)`);
  out.textContent = lines.join("\n");

  const metaLines = [];
  metaLines.push(`달성 EC(1 L 기준) = ${EC_calc_perL.toFixed(3)} mS/cm  /  목표 EC = ${ECt.toFixed(3)}  (차이 ${pm(EC_calc_perL-ECt)})`);
  metaLines.push(`K:N 현재(AB만) ≈ ${safeRatio(ratio_now)}  /  최종(AB+K₂SO₄) ≈ ${safeRatio(ratio_fin)}  /  목표 = ${(r).toFixed(3)}`);
  if(warns.length) metaLines.push("⚠️ " + warns.join(" "));
  meta.textContent = metaLines.join("\n");

  // 자세히 보기
  const dbgText = [];
  dbgText.push("[가정]");
  dbgText.push("- A:B는 항상 동량 (AB 혼합)");
  dbgText.push("- AB 혼합 밀도 = 1.21 g/mL (= mg/µL)");
  dbgText.push("- AB 혼합 100 mg당 N=5.75 mg, K=4.25 mg");
  dbgText.push(`- 10 wt% K₂SO₄ 용액 내 K 질량분율 fK ≈ ${F_K.toFixed(5)}`);
  dbgText.push("- EC 증분값은 모두 1 L 기준에서 정의됨");
  dbgText.push("");
  dbgText.push("[계산식 요약]");
  dbgText.push("sAB = dE_AB_500 / 500 (AB 1µL당 EC)");
  dbgText.push("gamma = dE_K_250 / 250 (K₂SO₄ 1µL당 EC)");
  dbgText.push("r = tK / tN");
  dbgText.push("c_raw = (1.21*(0.0575*r - 0.0425)) / (fK*rhoK),  c = max(0, c_raw)");
  dbgText.push("EC 1순위: (sAB + gamma*c) * vAB_perL = EC_target  →  vAB_perL = EC_target / (sAB + gamma*c),  vK_perL = c*vAB_perL");
  dbgText.push("배치 부피 반영: vAB_total = vAB_perL * Vbatch, vK_total = vK_perL * Vbatch");
  dbgText.push("");
  dbgText.push("[대입값/결과 (1 L 기준)]");
  dbgText.push(`Vbatch=${Vbatch} L, EC_target=${ECt}`);
  dbgText.push(`dE_AB_500=${dE_AB_500}, dE_K_250=${dE_K_250} → sAB=${sAB.toFixed(6)}, gamma=${gamma.toFixed(6)}`);
  dbgText.push(`rhoK=${rhoK}, tK=${tK}, tN=${tN}, r=${r.toFixed(6)}`);
  dbgText.push(`c_raw=${c_raw.toFixed(6)}, c=${c.toFixed(6)}`);
  dbgText.push(`vAB_perL=${vAB_perL.toFixed(3)}, vK_perL=${vK_perL.toFixed(3)}, EC_calc=${EC_calc_perL.toFixed(4)}`);
  dbgText.push("");
  dbgText.push("[배치 총량]");
  dbgText.push(`AB_total=${vAB_total.toFixed(3)} µL (A=${(vAB_total/2).toFixed(3)}, B=${(vAB_total/2).toFixed(3)}), K_total=${vK_total.toFixed(3)} µL`);
  dbgText.push(`V_total=${(vAB_total+vK_total).toFixed(3)} µL`);
  document.getElementById("debugBox").textContent = dbgText.join("\n");

  // 저장
  saveInputs();
}

/* ===== 이벤트 ===== */
document.getElementById("btnCalc").addEventListener("click", calculate);
window.addEventListener("load", loadInputs);
for(const id of ["Vbatch","ECt","dE_AB_500","dE_K_250","rhoK","tK","tN"]){
  const el = document.getElementById(id);
  el.addEventListener("change", saveInputs);
}
</script>
</body>
</html>

