<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>최적화 기반 양액 계산기 V3 FIX</title>

<style>
:root{ --brand:#007bff; --card-w:900px; }
*{box-sizing:border-box;}
body{background:#f6f7fa;font-family:Arial;padding:20px;text-align:center;}
h1{color:var(--brand);}
.wrap{max-width:var(--card-w);margin:0 auto;}
.card{
  background:#fff;padding:20px;border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,.08);text-align:left;margin-bottom:20px;
}
label{font-weight:700;display:block;margin-top:10px;}
input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:8px;}
.row{display:flex;flex-wrap:wrap;gap:12px;}
.row>div{flex:1 1 260px;}
.btn{
  width:100%;padding:14px;margin-top:20px;border:none;border-radius:10px;
  background:var(--brand);color:#fff;font-size:1.1rem;cursor:pointer;
}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:10px;border:1px solid #eee;}
th{background:#eef4ff;}
.switch{position:relative;width:32px;height:18px;display:inline-block;}
.switch input{opacity:0;width:0;height:0;}
.slider{
  position:absolute;inset:0;background:#cfe2ff;border-radius:999px;cursor:pointer;
}
.slider:before{
  content:'';position:absolute;width:14px;height:14px;left:2px;top:2px;background:#fff;
  border-radius:50%;transition:.25s;
}
input:checked + .slider{background:#a9c4ff;}
input:checked + .slider:before{transform:translateX(14px);}
</style>
</head>

<body>
<h1>최적화 기반 양액 계산기 V3</h1>

<div class="wrap">
<div class="card">

<h2>기본 입력</h2>
<div class="row">
  <div><label>배합 용량 (L)</label><input id="V" type="number"></div>
  <div><label>목표 EC (mS/cm)</label><input id="ECt" type="number" step="0.01"></div>
</div>

<h3>EC 증가량</h3>
<div class="row">
  <div><label>AB 500µL → ΔEC</label><input id="dAB" type="number" step="0.01"></div>
  <div><label>K₂SO₄ 250µL → ΔEC</label><input id="dK" type="number" step="0.01"></div>
  <div><label>MgSO₄ 250µL → ΔEC</label><input id="dMg" type="number" step="0.01"></div>
  <div><label>Ca(NO₃)₂ 250µL → ΔEC</label><input id="dCa" type="number" step="0.01"></div>
</div>

<h3>목표 Ca/Mg</h3>
<div class="row">
  <div><label>Ca 목표 (mg/L)</label><input id="CaT" type="number"></div>
  <div><label>Mg 목표 (mg/L)</label><input id="MgT" type="number"></div>
</div>

<h3>K:N 목표비 (근사)</h3>
<div class="row">
  <div><label>K 값</label><input id="Kr" type="number"></div>
  <div><label>N 값</label><input id="Nr" type="number"></div>
</div>

<h3>단위</h3>
<span>µL</span>
<label class="switch"><input id="unit" type="checkbox"><span class="slider"></span></label>
<span>mL</span>

<button class="btn" id="calc">계산하기</button>

<div id="result"></div>
<div id="meta" style="margin-top:20px;font-size:0.9rem;white-space:pre-line;"></div>

</div>
</div>


<script>
"use strict";

/* ================================
   DOM elements
================================ */
const V_el   = document.getElementById("V");
const ECt_el = document.getElementById("ECt");
const dAB_el = document.getElementById("dAB");
const dK_el  = document.getElementById("dK");
const dMg_el = document.getElementById("dMg");
const dCa_el = document.getElementById("dCa");
const CaT_el = document.getElementById("CaT");
const MgT_el = document.getElementById("MgT");
const Kr_el  = document.getElementById("Kr");
const Nr_el  = document.getElementById("Nr");
const unit_el= document.getElementById("unit");

/* ================================
   자동저장
================================ */
const STORE_KEY="nutri_calc_v3";
const fields=["V","ECt","dAB","dK","dMg","dCa","CaT","MgT","Kr","Nr","unit"];

function saveData(){
  const o={};
  fields.forEach(id=>{
    const el=document.getElementById(id);
    o[id]=(el.type==="checkbox")?el.checked:el.value;
  });
  localStorage.setItem(STORE_KEY,JSON.stringify(o));
}
function loadData(){
  const raw=localStorage.getItem(STORE_KEY);
  if(!raw) return;
  const o=JSON.parse(raw);
  fields.forEach(id=>{
    if(o[id]!==undefined){
      const el=document.getElementById(id);
      if(el.type==="checkbox") el.checked=o[id];
      else el.value=o[id];
    }
  });
}
fields.forEach(id=>{
  document.getElementById(id).addEventListener("input",()=>setTimeout(saveData,200));
});
loadData();

/* ================================
   성분 mg/mL
================================ */
const AB_N=47.40, AB_K=35.10, AB_Ca=18.50, AB_Mg=4.13;

const AT={Mg:24.305,Ca:40.078,O:15.999};
const Mg_frac=AT.Mg/(AT.Mg+AT.O);
const Ca_frac=AT.Ca/(AT.Ca+AT.O);

const mgMg=0.16*Mg_frac*0.1*1000;
const mgCa=0.26*Ca_frac*0.1*1000;

const MW_K2SO4=174.259;
const K_frac=(39.0983*2)/MW_K2SO4;
const mgK=K_frac*0.1*1000;

/* ================================
   선형 3×3
================================ */
function solve3(A,b){
  A=A.map(r=>r.slice());
  b=b.slice();
  for(let i=0;i<3;i++){
    let p=A[i][i];
    if(Math.abs(p)<1e-12){
      for(let r=i+1;r<3;r++){
        if(Math.abs(A[r][i])>1e-12){
          [A[i],A[r]]=[A[r],A[i]];
          [b[i],b[r]]=[b[r],b[i]];
          p=A[i][i];
          break;
        }
      }
    }
    for(let c=i;c<3;c++) A[i][c]/=p;
    b[i]/=p;
    for(let r=0;r<3;r++){
      if(r===i) continue;
      let m=A[r][i];
      for(let c=i;c<3;c++) A[r][c]-=m*A[i][c];
      b[r]-=m*b[i];
    }
  }
  return b;
}

/* ================================
   Golden-section
================================ */
function minimize(a,b,f){
  const phi=(1+Math.sqrt(5))/2;
  let c=b-(b-a)/phi;
  let d=a+(b-a)/phi;
  while(Math.abs(b-a)>1e-4){
    if(f(c)<f(d)){ b=d; d=c; c=b-(b-a)/phi; }
    else{ a=c; c=d; d=a+(b-a)/phi; }
  }
  return (a+b)/2;
}

/* ================================
   계산
================================ */
document.getElementById("calc").onclick=()=>{

  const V   = parseFloat(V_el.value);
  const ECt = parseFloat(ECt_el.value);

  const dAB = parseFloat(dAB_el.value)/500;
  const dK  = parseFloat(dK_el.value)/250;
  const dMgE= parseFloat(dMg_el.value)/250;
  const dCaE= parseFloat(dCa_el.value)/250;

  const CaT = parseFloat(CaT_el.value);
  const MgT = parseFloat(MgT_el.value);

  const Krv=parseFloat(Kr_el.value);
  const Nrv=parseFloat(Nr_el.value);
  const KNtarget=Krv/Nrv;

  const max_vK=(ECt*V)/dK*0.9;

  /* 목적함수 */
  function solveFor(vK){
    const RHS_EC=ECt*V - dK*vK;
    if(RHS_EC<0) return [-1,-1,-1];

    const b=[
      RHS_EC,
      CaT*V*1000,
      MgT*V*1000
    ];
    const A=[
      [dAB,     dMgE,       dCaE],
      [AB_Ca,   0,          mgCa],
      [AB_Mg,   mgMg,       0   ]
    ];
    return solve3(A,b);
  }

  function F(vK){
    const [vAB,vMgS,vCaS]=solveFor(vK);
    if(vAB<0||vMgS<0||vCaS<0) return 1e9;

    const K = vAB*AB_K + vK*mgK;
    const N = vAB*AB_N;
    if(N<=0) return 1e9;

    return (K/N - KNtarget)**2;
  }

  const vK_best=minimize(0,max_vK,F);
  const [vAB_best,vMg_best,vCa_best]=solveFor(vK_best);

  const unit = unit_el.checked?(1/1000):1;
  const uname= unit_el.checked?"mL":"µL";

  const Aamt=(vAB_best/2)*unit;
  const Bamt=(vAB_best/2)*unit;
  const Kamp=vK_best*unit;
  const Mgamp=vMg_best*unit;
  const Caamp=vCa_best*unit;

  result.innerHTML=`
  <table>
    <tr><th>원액</th><th>주입량 (${uname})</th></tr>
    <tr><td>A액</td><td>${Aamt.toFixed(2)}</td></tr>
    <tr><td>B액</td><td>${Bamt.toFixed(2)}</td></tr>
    <tr><td>K₂SO₄ 10%</td><td>${Kamp.toFixed(2)}</td></tr>
    <tr><td>MgSO₄ 10%</td><td>${Mgamp.toFixed(2)}</td></tr>
    <tr><td>Ca(NO₃)₂ 10%</td><td>${Caamp.toFixed(2)}</td></tr>
    <tr><td><b>총합</b></td><td><b>${(Aamt+Bamt+Kamp+Mgamp+Caamp).toFixed(2)}</b></td></tr>
  </table>`;

  meta.textContent=
`EC·Ca·Mg 정확히 충족됨.
K:N 근사 최적화 완료.

AB 구성 (mg/mL):
N=${AB_N}, K=${AB_K}, Ca=${AB_Ca}, Mg=${AB_Mg}`;
};
</script>

</body>
</html>
