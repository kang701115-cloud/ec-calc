<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>양액 계산기</title>
<style>
:root{ --brand:#007BFF; --brand-dark:#0056b3; --card-w: 760px; }
*{box-sizing:border-box}
body{ font-family: Arial, sans-serif; background:#f7f8fa; margin:0; padding:24px; text-align:center; }
h1{color:var(--brand); font-size:2.1rem; margin:0 0 18px}
.wrap{max-width:var(--card-w); margin:0 auto}
.card{ background:#fff; padding:20px; margin:16px auto; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,.06); text-align:left; font-size:1.06rem; }
.card h2{margin:0 0 10px; font-size:1.22rem; color:#222}
label{display:block; margin-top:12px; font-weight:700}
.row{display:flex; gap:12px; flex-wrap:wrap}
.row > div{flex:1 1 220px}
input{ width:100%; padding:12px; margin-top:6px; border:1px solid #d7d7d7; border-radius:10px; font-size:1.05rem; background:#fff; }
.btn{ margin-top:16px; padding:13px 16px; width:100%; background:var(--brand); color:#fff; border:none; border-radius:10px; cursor:pointer; font-size:1.08rem; }
.btn:hover{background:var(--brand-dark)}
.result{margin-top:14px; font-weight:700; color:#222; font-size:1.06rem}
.meta{font-size:.96rem; color:#333; white-space:pre-line; margin-top:10px}
.bad{color:#b00020; font-weight:700}
.footer{font-size:.9rem; color:#666; margin-top:16px}

/* Floating controls (우측 상단 고정) */
.floating{
  position:fixed; top:16px; right:16px; z-index:1000;
  display:flex; flex-direction:column; gap:8px; align-items:flex-end;
}
.float-box{
  display:flex; align-items:center; gap:8px;
  background:#ffffffd9; backdrop-filter:saturate(180%) blur(6px);
  border:1px solid #e7e7e7; border-radius:999px; padding:6px 10px;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.mode-chip{font-weight:700; color:#274690; background:#eef6ff; padding:4px 8px; border-radius:999px; font-size:.86rem}
.mode-chip.inactive{opacity:.55}

/* Small switches (기존의 절반 크기) */
.switch{position:relative; display:inline-block; width:32px; height:16px}
.switch input{opacity:0; width:0; height:0}
.slider{
  position:absolute; cursor:pointer; inset:0; background:#cfe2ff; transition:.2s; border-radius:999px
}
.slider:before{
  position:absolute; content:""; height:12px; width:12px; left:2px; top:2px;
  background:#fff; transition:.2s; border-radius:50%; box-shadow:0 1px 4px rgba(0,0,0,.15)
}
input:checked + .slider{background:#bcd0ff}
input:checked + .slider:before{transform:translateX(16px)}

/* Table */
table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:1.0rem}
th, td{ border:1px solid #eee; padding:10px 8px; text-align:right }
th{ background:#f3f6ff; color:#123}
td:first-child, th:first-child{ text-align:left }
details{margin-top:10px}
details > summary{cursor:pointer; user-select:none; padding:8px 10px; background:#f0f4ff; border:1px solid #d9e2ff; border-radius:10px; color:#274690; font-weight:700}
.details-body{padding:10px 2px; font-size:.98rem; color:#333; white-space:pre-line}
.hidden{display:none}
</style>
</head>
<body>
<!-- 우측 상단: 모드 스위치 + 단위 토글 -->
<div class="floating">
  <div class="float-box" title="모드 전환">
    <span id="chipSimple" class="mode-chip">양액만</span>
    <label class="switch">
      <input id="modeSwitch" type="checkbox"/>
      <span class="slider"></span>
    </label>
    <span id="chipK" class="mode-chip inactive">칼륨 보충</span>
  </div>

  <div class="float-box" title="단위 전환 (µL ↔ mL)">
    <span class="mode-chip" id="unitLabelLeft">µL</span>
    <label class="switch">
      <input id="unitSwitch" type="checkbox"/>
      <span class="slider"></span>
    </label>
    <span class="mode-chip inactive" id="unitLabelRight">mL</span>
  </div>
</div>

<h1>양액 배합 계산기</h1>
<div class="wrap">

  <!-- 양액만 모드 -->
  <div class="card" id="cardSimple">
    <h2>양액만</h2>
    <div class="row">
      <div>
        <label for="VbatchS">배합 용량 (L)</label>
        <input type="number" id="VbatchS" step="0.1" min="0" placeholder="예: 2, 20">
      </div>
      <div>
        <label for="ECtS">목표 EC (mS/cm)</label>
        <input type="number" id="ECtS" step="0.01" min="0" placeholder="예: 1.20">
      </div>
    </div>
    <div class="row">
      <div>
        <label for="dE_AB_500S">AB 각 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dE_AB_500S" step="0.01" min="0" placeholder="예: 0.80">
      </div>
    </div>
    <button class="btn" id="btnCalcS">계산하기</button>
    <div class="result" id="resultS"></div>
    <div class="meta" id="metaS"></div>
  </div>

  <!-- 칼륨 보충 모드 -->
  <div class="card hidden" id="cardK">
    <h2>칼륨 보충</h2>
    <div class="row">
      <div>
        <label for="Vbatch">배합 용량 (L)</label>
        <input type="number" id="Vbatch" step="0.1" min="0" placeholder="예: 2, 20">
      </div>
      <div>
        <label for="ECt">목표 EC (mS/cm)</label>
        <input type="number" id="ECt" step="0.01" min="0" placeholder="예: 1.20">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="dE_AB_500">AB 각 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dE_AB_500" step="0.01" min="0" placeholder="예: 0.80">
      </div>
      <div>
        <label for="dE_K_250">10% K₂SO₄ 250 µL → EC 증가 (mS/cm)</label>
        <input type="number" id="dE_K_250" step="0.01" min="0" placeholder="예: 0.05">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="rhoK">10% K₂SO₄ 밀도 (g/mL)</label>
        <input type="number" id="rhoK" step="0.001" min="0" value="1.00">
      </div>
      <div>
        <label for="tK">목표 K</label>
        <input type="number" id="tK" step="0.01" min="0.0001" placeholder="예: 1">
      </div>
      <div>
        <label for="tN">목표 N</label>
        <input type="number" id="tN" step="0.01" min="0.0001" placeholder="예: 1">
      </div>
    </div>

    <button class="btn" id="btnCalc">계산하기</button>
    <div class="result" id="result"></div>
    <div class="meta" id="meta"></div>

    <details>
      <summary>자세히</summary>
      <div class="details-body" id="debugBox"></div>
    </details>
  </div>

  <div class="footer"></div>
</div>

<script>
"use strict";

/* ===== 상수 ===== */
const RHO_AB = 1.21; // g/mL (AB 혼합 밀도)
const ATOMIC = { K: 39.0983, S: 32.065, O: 15.999 };
const M_K2SO4 = 2*ATOMIC.K + ATOMIC.S + 4*ATOMIC.O;
const MASSFRAC_K_IN_K2SO4 = (2*ATOMIC.K) / M_K2SO4; // ≈0.4487
const F_K = 0.10 * MASSFRAC_K_IN_K2SO4;             // 10% 용액 내 K 질량비 ≈ 0.04487

/* ===== 유틸 ===== */
const $ = id => document.getElementById(id);
const getNum = id => { const v = parseFloat($(id).value); return Number.isFinite(v)? v : NaN; };
const round1 = x => Math.round(x*10)/10;
const setHTML = (id, html) => $(id).innerHTML = html;
const setText = (id, txt) => $(id).textContent = txt;
const warn = msg => `<span class="bad">${msg}</span>`;

/* ===== 저장키 ===== */
const KEY_SIMPLE = "nutri_calc_simple_v2";
const KEY_KMODE  = "nutri_calc_kmode_v2";
const KEY_MODE   = "nutri_calc_mode_v2"; // false=simple, true=K
const KEY_UNIT   = "nutri_calc_unit_v2"; // false=uL, true=mL

/* ===== 모드/단위 상태 ===== */
function isKMode(){ return !!JSON.parse(localStorage.getItem(KEY_MODE) || "false"); }
function isUnitML(){ return !!JSON.parse(localStorage.getItem(KEY_UNIT) || "false"); }
function applyModeUI(isK){
  $("cardSimple").classList.toggle("hidden",  isK);
  $("cardK").classList.toggle("hidden",      !isK);
  $("modeSwitch").checked = !!isK;
  $("chipSimple").classList.toggle("inactive", !!isK);
  $("chipK").classList.toggle("inactive",     !isK);
  localStorage.setItem(KEY_MODE, JSON.stringify(!!isK));
}
function applyUnitUI(isML){
  $("unitSwitch").checked = !!isML;
  $("unitLabelLeft").classList.toggle("inactive",  !!isML); // µL
  $("unitLabelRight").classList.toggle("inactive", !isML);  // mL
  localStorage.setItem(KEY_UNIT, JSON.stringify(!!isML));
}

/* ===== 저장/불러오기 ===== */
function saveSimple(){
  const data={ VbatchS:getNum("VbatchS"), ECtS:getNum("ECtS"), dE_AB_500S:getNum("dE_AB_500S") };
  localStorage.setItem(KEY_SIMPLE, JSON.stringify(data));
}
function loadSimple(){
  const raw=localStorage.getItem(KEY_SIMPLE); if(!raw) return;
  try{ const d=JSON.parse(raw); for(const k of Object.keys(d)){ if($(k) && typeof d[k]==="number" && !Number.isNaN(d[k])) $(k).value=d[k]; } }catch(e){}
}
function saveK(){
  const data={ Vbatch:getNum("Vbatch"), ECt:getNum("ECt"), dE_AB_500:getNum("dE_AB_500"), dE_K_250:getNum("dE_K_250"), rhoK:getNum("rhoK"), tK:getNum("tK"), tN:getNum("tN") };
  localStorage.setItem(KEY_KMODE, JSON.stringify(data));
}
function loadK(){
  const raw=localStorage.getItem(KEY_KMODE); if(!raw) return;
  try{ const d=JSON.parse(raw); for(const k of Object.keys(d)){ if($(k) && typeof d[k]==="number" && !Number.isNaN(d[k])) $(k).value=d[k]; } }catch(e){}
}

/* ===== 단위 변환/표 렌더 ===== */
function unitName(){ return isUnitML() ? "mL" : "µL"; }
function toUnit(value_uL){
  if(isUnitML()) return round1(value_uL/1000);   // mL: 소수 1자리 반올림
  return Number(value_uL.toFixed(1));            // µL: 소수 1자리
}
function formatCell(value_uL){ return toUnit(value_uL).toFixed(1); }
function renderTableSimple(vA_uL, vB_uL){
  const unit = unitName();
  const headers = `<thead><tr><th>항목</th><th>주입량 (${unit})</th></tr></thead>`;
  const body = `
    <tbody>
      <tr><td>A액</td><td>${formatCell(vA_uL)}</td></tr>
      <tr><td>B액</td><td>${formatCell(vB_uL)}</td></tr>
      <tr><td><b>합계(AB)</b></td><td><b>${formatCell(vA_uL+vB_uL)}</b></td></tr>
    </tbody>`;
  return `<table>${headers}${body}</table>`;
}
function renderTableK(vA_uL, vB_uL, vK_uL){
  const unit = unitName();
  const headers = `<thead><tr><th>항목</th><th>주입량 (${unit})</th></tr></thead>`;
  const body = `
    <tbody>
      <tr><td>A액</td><td>${formatCell(vA_uL)}</td></tr>
      <tr><td>B액</td><td>${formatCell(vB_uL)}</td></tr>
      <tr><td>10% K₂SO₄</td><td>${formatCell(Math.max(0, vK_uL))}</td></tr>
      <tr><td><b>합계</b></td><td><b>${formatCell(vA_uL+vB_uL+Math.max(0, vK_uL))}</b></td></tr>
    </tbody>`;
  return `<table>${headers}${body}</table>`;
}

/* ===== 계산 로직 ===== */
function calcSimple(){
  const Vbatch = getNum("VbatchS");
  const ECt    = getNum("ECtS");
  const dE     = getNum("dE_AB_500S");
  const outId  = "resultS"; const metaId="metaS";
  setText(outId, ""); setText(metaId, "");

  if([Vbatch,ECt,dE].some(v=>!Number.isFinite(v) || v<0)) { setHTML(outId, warn("입력값 확인.")); return; }
  if(Vbatch===0){ setHTML(outId, warn("배치 부피는 0 불가.")); return; }
  if(dE===0){ setHTML(outId, warn("AB 500 µL의 EC 증가가 0.")); return; }

  const sAB = dE/500;          // 1 µL당 mS/cm
  const vAB_perL = ECt / sAB;  // 1 L 당 AB 총 µL
  const vAB_total = vAB_perL * Vbatch;
  const vA_total = vAB_total/2; const vB_total=vAB_total/2;

  setHTML(outId, renderTableSimple(vA_total, vB_total));

  const EC_calc = (dE/500)*vAB_perL; // 검증 (1 L 기준)
  setText(metaId, `달성 EC = ${EC_calc.toFixed(3)} mS/cm / 목표 = ${ECt.toFixed(3)} (Δ ${(EC_calc-ECt>=0?'+':'')}${(EC_calc-ECt).toFixed(3)})`);

  saveSimple();
}

function calcK(){
  const Vbatch   = getNum("Vbatch");
  const ECt      = getNum("ECt");
  const dE_AB_500= getNum("dE_AB_500");
  const dE_K_250 = getNum("dE_K_250");
  const rhoK     = getNum("rhoK");
  const tK       = getNum("tK");
  const tN       = getNum("tN");

  setText("result", ""); setText("meta", ""); setText("debugBox", "");

  if([Vbatch,ECt,dE_AB_500,dE_K_250,rhoK,tK,tN].some(v=>!Number.isFinite(v) || v<0)) { setHTML("result", warn("입력값 확인.")); return; }
  if(Vbatch===0){ setHTML("result", warn("배치 부피는 0 불가.")); return; }
  if(tK===0 || tN===0){ setHTML("result", warn("목표 비의 각 항은 0 초과.")); return; }

  const sAB   = dE_AB_500 / 500;  // AB 1µL당 mS/cm
  const gamma = dE_K_250  / 250;  // K2SO4 1µL당 mS/cm

  const r = tK / tN;
  const c_raw = (RHO_AB * (0.0575*r - 0.0425)) / (F_K * rhoK);
  const c = Math.max(0, c_raw); // 음수면 K 감소 불가 → 0

  const denom = sAB + gamma*c;
  if(denom <= 0){ setHTML("result", warn("EC 기울기 합이 0 이하.")); return; }

  const vAB_perL = ECt / denom;
  const vK_perL  = c * vAB_perL;

  const vAB_total = vAB_perL * Vbatch;
  const vK_total  = vK_perL  * Vbatch;
  const vA_total  = vAB_total/2; const vB_total = vAB_total/2;

  setHTML("result", renderTableK(vA_total, vB_total, vK_total));

  // 메타
  const EC_calc_perL = sAB*vAB_perL + gamma*vK_perL;
  const metaLines=[];
  metaLines.push(`달성 EC = ${EC_calc_perL.toFixed(3)} mS/cm / 목표 = ${ECt.toFixed(3)} (Δ ${(EC_calc_perL-ECt>=0?'+':'')}${(EC_calc_perL-ECt).toFixed(3)})`);
  setText("meta", metaLines.join("\n"));

  // 자세히
  const dbg=[];
  dbg.push("[상수] AB 밀도 1.21 g/mL, AB 100 mg당 N 5.75 mg, K 4.25 mg");
  dbg.push(`[상수] fK(10% K₂SO₄ 내 K 질량분율) ≈ ${F_K.toFixed(5)}`);
  dbg.push(`[식] vAB = EC_target / (sAB + gamma*c), vK = c*vAB`);
  dbg.push(`[값] sAB=${(dE_AB_500/500).toFixed(6)}, gamma=${(dE_K_250/250).toFixed(6)}, c=${c.toFixed(6)}`);
  dbg.push(`[1 L] vAB=${vAB_perL.toFixed(3)} µL, vK=${vK_perL.toFixed(3)} µL`);
  setText("debugBox", dbg.join("\n"));

  saveK();
}

/* ===== 보조: 현재 보이는 모드 재계산 ===== */
function recalcActive(){
  if(isKMode()) calcK(); else calcSimple();
}

/* ===== 이벤트 ===== */
$("btnCalcS").addEventListener("click", calcSimple);
$("btnCalc").addEventListener("click", calcK);
["VbatchS","ECtS","dE_AB_500S"].forEach(id=> $(id).addEventListener("change", saveSimple));
["Vbatch","ECt","dE_AB_500","dE_K_250","rhoK","tK","tN"].forEach(id=> $(id).addEventListener("change", saveK));

// 모드 전환: 스위치/칩 클릭 모두 지원
$("modeSwitch").addEventListener("change", e=> { applyModeUI(e.target.checked); recalcActive(); });
$("chipSimple").addEventListener("click", ()=> { applyModeUI(false); recalcActive(); });
$("chipK").addEventListener("click", ()=> { applyModeUI(true); recalcActive(); });

// 단위 전환
$("unitSwitch").addEventListener("change", e=> { applyUnitUI(e.target.checked); recalcActive(); });

/* ===== 초기 로드 ===== */
(function init(){
  // 상태 복원
  const isK = isKMode();
  const isML = isUnitML();
  applyModeUI(isK);
  applyUnitUI(isML);

  // 값 복원
  const rawS = localStorage.getItem(KEY_SIMPLE);
  const rawK = localStorage.getItem(KEY_KMODE);
  if(rawS) loadSimple();
  if(rawK) loadK();
})();
</script>
</body>
</html>
